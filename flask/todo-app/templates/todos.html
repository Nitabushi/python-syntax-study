<!doctype html>
<html>
<head>
    <title>ToDoリスト</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>{{ current_user.username }} さんのToDoリスト</h1>
    <p>現在のタスク数：{{ tasks|length }} 件</p>
    <p>
        並び順:
        <a href="{{ url_for('todos', order='asc') }}">昇順</a> |
        <a href="{{ url_for('todos', order='desc') }}">降順</a>
    </p>

    <form method="POST" action="{{ url_for('todos') }}">
        <input type="text" name="task" placeholder="新しいタスクを入力">
        <button type="submit">追加</button>
    </form>

    <form method="POST" action="{{ url_for('bulk_action') }}">
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="checkAll"></th>
                    <th>タスク</th>
                    <th>作成日時</th>
                    <th>状態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr>
                    <td><input type="checkbox" name="task_ids" value="{{ task.id }}"></td>
                    <td>
                        {% if task.completed %}
                            <s>{{ task.task }}</s>
                        {% else %}
                            {{ task.task }}
                        {% endif %}
                    </td>
                    <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ '完了' if task.completed else '未完了' }}</td>
                    <td class="actions">
                        <a href="{{ url_for('complete_task', task_id=task.id) }}">
                            {% if task.completed %}未完了に戻す{% else %}完了{% endif %}
                        </a>
                        <a href="{{ url_for('delete_task', task_id=task.id) }}">削除</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" name="action" value="complete">選択完了/未完了</button>
        <button type="submit" name="action" value="delete">選択削除</button>
    </form>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="flash">
        <ul>
        {% for message in messages %}
            <li>{{ message }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% endwith %}

    <p><a href="{{ url_for('logout') }}">ログアウト</a></p>

    <script>
    document.getElementById('checkAll').addEventListener('change', function() {
        document.querySelectorAll('input[name="task_ids"]').forEach(cb => {
            cb.checked = this.checked;
        });
    });
    </script>
</body>
</html>
